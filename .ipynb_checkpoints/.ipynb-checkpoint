{
 "cells": [
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      "--- request header ---\n",
      "GET /v1/marketdata/ethbtc?bids=true&offers=true HTTP/1.1\n",
      "Upgrade: websocket\n",
      "Connection: Upgrade\n",
      "Host: api.gemini.com\n",
      "Origin: http://api.gemini.com\n",
      "Sec-WebSocket-Key: pvOMov+75CENmI03/HVSSg==\n",
      "Sec-WebSocket-Version: 13\n",
      "\n",
      "\n",
      "-----------------------\n",
      "--- response header ---\n",
      "HTTP/1.1 101 Switching Protocols\n",
      "Date: Tue, 04 Dec 2018 19:59:09 GMT\n",
      "Connection: upgrade\n",
      "Server: nginx\n",
      "Upgrade: websocket\n",
      "Sec-WebSocket-Accept: outUwsH1S8dFr4uwnaxs4fpCi7Y=\n",
      "-----------------------\n",
      "send: b'\\x89\\x80 v\\x15\\x11'\n",
      "send: b'\\x89\\x80\\x93=W@'\n",
      "send: b'\\x89\\x80\\x86\\xf8\\x8e\\x94'\n",
      "send: b'\\x89\\x80\\x84\\x04)m'\n",
      "send: b'\\x89\\x802Y|\\x18'\n",
      "send: b'\\x89\\x80\\xb3-:\\x95'\n",
      "send: b'\\x89\\x80jE\\xfa\\xb0'\n",
      "send: b'\\x89\\x80\\x92>T\\xe1'\n",
      "send: b'\\x89\\x80\\x9e\\x0cJ\\x96'\n",
      "send: b'\\x89\\x80J\\xc1\\x0cY'\n",
      "send: b'\\x89\\x80\\xdb#\\x87\\xbb'\n",
      "send: b'\\x89\\x80)\\xb0\\xe4\\xb2'\n",
      "send: b'\\x89\\x80)l>\\xb4'\n",
      "send: b'\\x89\\x80CS\\x12\\x08'\n",
      "send: b'\\x89\\x80t\\x91\\xbfJ'\n",
      "send: b'\\x89\\x80\\xbe\\xd8gD'\n",
      "send: b'\\x89\\x80\\x91`\\xbd\\xd0'\n",
      "send: b'\\x89\\x808\\xe3\\xcc\\xd8'\n",
      "send: b'\\x89\\x802|%\\xd2'\n",
      "send: b'\\x89\\x80/\\xd7\\x14\\xcf'\n",
      "send: b'\\x89\\x80\\xa7rf\\xef'\n",
      "send: b'\\x89\\x80\\r5\\xd2?'\n",
      "send: b'\\x89\\x80zvY;'\n",
      "send: b'\\x89\\x80\\x1713Y'\n",
      "send: b'\\x89\\x809\\xcd\\xcfV'\n",
      "send: b'\\x89\\x80y\\xd4y\\x15'\n",
      "send: b'\\x89\\x80we\\x84\\xcf'\n",
      "send: b'\\x89\\x80\\xcc\\xe6(\\xe7'\n",
      "send: b'\\x89\\x80\\xa9Y\\xecC'\n",
      "send: b'\\x89\\x80\\xd0\\xdf\\xb5['\n",
      "send: b'\\x89\\x80\\x89\\xd5u\\xf1'\n",
      "send: b'\\x89\\x80n,\\x85\\xa0'\n",
      "send: b'\\x89\\x80O]\\x10\\xdd'\n",
      "send: b'\\x89\\x80\\xc7\\x87\\xdd\"'\n",
      "send: b'\\x89\\x80\\xb32\\xef\\x8e'\n",
      "send: b'\\x89\\x80\\xc8K\\xbb\\xf9'\n",
      "send: b'\\x89\\x80\\x98\\x9fKv'\n",
      "send: b'\\x89\\x80a\\xda\\xff\\\\'\n",
      "send: b'\\x89\\x80h\\x0bM\\xd0'\n",
      "send: b'\\x89\\x80\\x12x\\x19\\xb3'\n",
      "send: b'\\x89\\x80\\x85\\x8d?Z'\n",
      "send: b'\\x89\\x80\\xaf\\x01\\xf9\\xd5'\n",
      "send: b'\\x89\\x80\\xe0\\xe9/\\x04'\n",
      "send: b'\\x89\\x80?\\x9b\\xf4\\xfe'\n",
      "send: b'\\x89\\x80\\xa1\\xc0\\x0ce'\n",
      "send: b'\\x89\\x80\\xa0\\xaa\\x9d\\x1a'\n",
      "send: b'\\x89\\x80\\xceS\\x0c\\x82'\n",
      "send: b'\\x89\\x80\\xb9#\\x13\\x80'\n",
      "send: b'\\x89\\x80\\xff\\x8a\\x9b\\x0b'\n",
      "send: b'\\x89\\x80=\\xad}\\xf0'\n",
      "send: b'\\x89\\x80\\x90)w\\xbe'\n",
      "send: b'\\x89\\x80\\x7f\\xdd%g'\n",
      "send: b'\\x89\\x80q;\\xf4J'\n",
      "send: b'\\x89\\x80\\x9a\\xd5b\\x88'\n",
      "send: b'\\x89\\x80-G=\\x15'\n",
      "send: b'\\x89\\x80\\xd8\\x15\\xcd\\xba'\n",
      "send: b'\\x89\\x80\\xb1\\x85\\xbf\\xbd'\n",
      "send: b'\\x89\\x80)\\x95\\xb26'\n",
      "send: b'\\x89\\x80W\\xc8\\x00U'\n",
      "send: b'\\x89\\x807\\xfeoB'\n",
      "send: b'\\x89\\x80P\\x9fD\\x1e'\n",
      "send: b'\\x89\\x80\\xcb\\xfc6\\x81'\n",
      "send: b'\\x89\\x80/\\x04z\\xd3'\n",
      "send: b'\\x89\\x80\\xe2x?\\xe6'\n",
      "send: b\"\\x89\\x80\\x809'(\"\n",
      "send: b'\\x89\\x80S\\xf2^\\xb9'\n",
      "send: b'\\x89\\x80\\xa9\\x10\\x0e`'\n",
      "send: b'\\x89\\x80\\xd4\\x08\\x9b\\xcf'\n",
      "send: b'\\x89\\x80\\x9f.\\xed\\r'\n",
      "send: b'\\x89\\x80\\xbfj\\xec\\xe0'\n",
      "send: b'\\x89\\x80\\xbf\\x9c)s'\n",
      "send: b'\\x89\\x80\\xf8\\x19\\xb1L'\n",
      "send: b'\\x89\\x80k\\xffd\\xbe'\n",
      "send: b'\\x89\\x80L\\x81\\x00\\xb1'\n",
      "send: b'\\x89\\x80N\"\\xf3\\x08'\n",
      "send: b'\\x89\\x80\\xf0\\xa6r\\\\'\n",
      "send: b'\\x89\\x80\\xdd\\x8c\\xe9T'\n",
      "send: b\"\\x89\\x80\\x9a'\\xa1\\xf6\"\n",
      "send: b'\\x89\\x80\\t\\x8cwa'\n",
      "send: b'\\x89\\x80\\xca\\xff\\x92\\x07'\n",
      "send: b'\\x89\\x80\\x9a&\\x02\\xc1'\n",
      "send: b'\\x89\\x80\\xd7u[7'\n",
      "send: b'\\x89\\x80C`}1'\n",
      "send: b'\\x89\\x80 \\xd1\\xfb\\x90'\n",
      "send: b'\\x89\\x80\\xc2\\xbc\\x0f1'\n",
      "send: b'\\x89\\x80\\x85\\xca\"\\x01'\n",
      "send: b'\\x89\\x80\\x9f\\x91\\xff\\xc0'\n",
      "send: b'\\x89\\x80j*\\x8c>'\n",
      "send: b'\\x89\\x80L\\x19c<'\n",
      "send: b'\\x89\\x80/\\xd4\\xafr'\n",
      "send: b'\\x89\\x80\\x1dv\\x1b0'\n",
      "send: b'\\x89\\x80\\xc8n\\r\\xdf'\n",
      "send: b'\\x89\\x80\\x81:]E'\n",
      "send: b'\\x89\\x80\\xb4[\\xb7\\x04'\n",
      "send: b'\\x89\\x80-\\x8cN\\xc4'\n",
      "send: b'\\x89\\x80\\x0f\\x8ep\\x98'\n",
      "send: b'\\x89\\x80\\x0c\\xd5E\\x95'\n",
      "send: b'\\x89\\x80\\\\\\xbct\\xa2'\n",
      "send: b'\\x89\\x80\\xac\\x04\\xaf}'\n",
      "send: b'\\x89\\x80J\\nN\\xcc'\n",
      "send: b'\\x89\\x80\\xcc\\xb0\\xfa\\xba'\n",
      "send: b'\\x89\\x80\\xad,Za'\n",
      "send: b'\\x89\\x80\\xa9\"o\\xb4'\n",
      "send: b'\\x89\\x80Y<\\xd33'\n",
      "send: b'\\x89\\x80\\xc1\\x18\\x951'\n",
      "send: b'\\x89\\x80\\xca\\xaef\\xe0'\n",
      "send: b'\\x89\\x80\\xe0\\x887\\x98'\n",
      "send: b'\\x89\\x80E\\xe1\\x16\\xab'\n",
      "send: b'\\x89\\x80\\x81\\xb4\\xba/'\n",
      "send: b'\\x89\\x80\\x1bK\\x9a\\xf9'\n",
      "send: b'\\x89\\x80 ja\\xfa'\n",
      "send: b'\\x89\\x80\\x9e\\xebX\\xf8'\n",
      "send: b'\\x89\\x80gH\\xd2Q'\n",
      "send: b'\\x89\\x80R\\x80q\\x1c'\n",
      "send: b'\\x89\\x80\\xc3\\xe6QY'\n",
      "send: b'\\x89\\x80u\\xa8\\x05{'\n",
      "send: b'\\x89\\x80\\x9f\\\\\\x83\\xa0'\n",
      "send: b'\\x89\\x80L\\xeb\\xb9?'\n",
      "send: b'\\x89\\x80\\xa9\\x056*'\n",
      "send: b'\\x89\\x80M\\xc1\\x9e\\xc3'\n",
      "send: b'\\x89\\x80aZ\\xb4['\n",
      "send: b'\\x89\\x80*)Q\\x02'\n",
      "send: b'\\x89\\x80\\xbd\\xf7\\x90|'\n",
      "send: b'\\x89\\x80\\xf4U_\\xf1'\n",
      "send: b'\\x89\\x80n\\xab\\xa8t'\n",
      "send: b'\\x89\\x80\\x958V\\x0e'\n",
      "send: b'\\x89\\x80\\xedu\\xd8h'\n",
      "send: b'\\x89\\x80\\n4zq'\n",
      "send: b'\\x89\\x80\\x13\\x1f\\xccR'\n",
      "send: b'\\x89\\x80T-xz'\n",
      "send: b'\\x89\\x80\\xc5 \\xddB'\n",
      "send: b'\\x89\\x80Ts\\x9b0'\n",
      "send: b'\\x89\\x80\\xe9\\xa0\\xf6\\xa8'\n",
      "send: b'\\x89\\x80\\xaf\\xc23\\xe1'\n",
      "send: b'\\x89\\x80K5\\xdc\\xea'\n",
      "send: b'\\x89\\x80\\xc3RRA'\n",
      "send: b'\\x89\\x80\\xb8\\xdd\\xe9H'\n",
      "send: b'\\x89\\x80$\\x94u\\xbc'\n",
      "send: b\"\\x89\\x80'\\x04\\xe1\\xdc\"\n",
      "send: b'\\x89\\x80\\xba\\x1d\\xf5\\x13'\n",
      "send: b'\\x89\\x80\\x11\\xce\\xc6$'\n",
      "send: b'\\x89\\x80\\xec_5\\xf6'\n",
      "send: b'\\x89\\x80\\xa0 x\\x92'\n",
      "send: b'\\x89\\x80\\xf6\\x13\\x0e\\x18'\n",
      "send: b'\\x89\\x80\\x90LD\\x10'\n",
      "send: b'\\x89\\x80m\\xab^P'\n",
      "send: b'\\x89\\x80\\xca\\x1f\\x87\\xd7'\n",
      "send: b'\\x89\\x80\\x92\\xad{}'\n",
      "send: b'\\x89\\x80\\xdep\\xcf\\xd0'\n",
      "send: b'\\x89\\x80\\x12^ \\xaa'\n",
      "send: b'\\x89\\x80\\x9dE\\xd5r'\n",
      "send: b'\\x89\\x80\\xc06\\xc6-'\n"
     ]
    }
   ],
   "source": [
    "import websocket\n",
    "import json\n",
    "import pandas as pd\n",
    "try:\n",
    "    import thread\n",
    "except ImportError:\n",
    "    import _thread as thread\n",
    "import time\n",
    "\n",
    "coin = \"ethbtc\" #Set you coin\n",
    "init = 1\n",
    "header = {\"type\":[],\"eventId\":[],\"timestamp\":[],\"timestampms\":[],\"socket_sequence\":[],\"delta\":[],\"price\":[],\"reason\":[],\"remaining\":[],\"side\":[],\"events-type\":[]}\n",
    "header = pd.DataFrame(header)\n",
    "\n",
    "def on_message(ws, message):\n",
    "    result = json.loads(message)\n",
    "    lst = pd.DataFrame.from_dict(result)\n",
    "    global init, coin\n",
    "    if (init == 1):\n",
    "        #file path, one for initial data, one for transaction records\n",
    "        #the folder needs to be created before the program\n",
    "        lst.to_csv('1-10/'+coin+'_init.csv', header=True, index=False)\n",
    "        header.to_csv('1-10/'+coin+'.csv', header=True,index=False)\n",
    "        init = 0\n",
    "    else:\n",
    "        events = pd.DataFrame.from_dict(result['events']) \n",
    "        lst = lst.drop('events',axis=1)\n",
    "        lst = pd.concat([lst,events],axis=1)\n",
    "        lst.to_csv('1-10/'+coin+'.csv', mode= 'a', header=False, index=False)\n",
    "def on_error(ws, error):\n",
    "    print(error)\n",
    "\n",
    "def on_close(ws):\n",
    "    print(\"### closed ###\")\n",
    "\n",
    "if __name__ == \"__main__\":\n",
    "    websocket.enableTrace(True)\n",
    "    #url here, add any other options according to API document\n",
    "    ws = websocket.WebSocketApp(\"wss://api.gemini.com/v1/marketdata/\"+coin+\"?bids=true&offers=true\",\n",
    "                              on_message = on_message,\n",
    "                              on_error = on_error,\n",
    "                              on_close = on_close)\n",
    "    ws.run_forever(ping_interval=60,ping_timeout=5)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "metadata": {},
   "outputs": [],
   "source": []
  }
 ],
 "metadata": {
  "kernelspec": {
   "display_name": "Python 3",
   "language": "python",
   "name": "python3"
  },
  "language_info": {
   "codemirror_mode": {
    "name": "ipython",
    "version": 3
   },
   "file_extension": ".py",
   "mimetype": "text/x-python",
   "name": "python",
   "nbconvert_exporter": "python",
   "pygments_lexer": "ipython3",
   "version": "3.7.0"
  }
 },
 "nbformat": 4,
 "nbformat_minor": 2
}
